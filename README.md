# malware_study_doc

## 1. ネットワーク概要

まず流れとしては

ハニポ・正常通信の情報収集
    |
    v
機械学習用のマシン（仮想か実機化は未定）に流す
    |
    V
その情報を元にNIDSの設定を変更する

NIDSは過去の学習情報から正常通信と悪性通信を識別。
正常通信は学習に利用。悪性通信はNIPSに通知する。

  
## 2. ハニーポット

以下のハニーポットを使用。

- Honeytrap
- Dionaea
- Cowrie

logファイルがかなり容量を使ってしまうためNASを設置する予定です。

コンテナの起動は
~~~
 docker exec -it {CONTAINER} sh
~~~


### 現在稼働中のもの

#### Honeytrap
~~~
$sudo docker build -t honeytrap .
$sudo docker run -p 6379:6379 -p 11211:11211 -p 23:23 -p 389:389 -p 8545:8545 -p 5555:5555 -p 27016:27016 -p 5037:5037 -p 3890:3890 -p 9200:9200 -p 8022:8022 -p 8080:8080 --name honeytrap CONTAINER_NAME
$sudo tcpdump -i NICID -G 3600 -B 65535 -w %Y%m%d%H%M%S.pcap
~~~
こんな感じで実行しています

  
## 3. NIDS

学習データから通信を仕分けする。

少なくともコマンドを定期実行していくことは確定なので下記記事を参考にcronコマンドを使用していく
(cronを用いたコマンドの定期実行)[https://staffblog.amelieff.jp/entry/2018/07/06/150851]

### memo
NIDSについてが全くわからない。すべての通信を随時見ていってマシンパワーが足りるのかがなぞ。だからといって時間をおいて見ていたら手遅れ。
とりあえず動くことが目標なので、学習データを適当につくって判別（笑）機能をつける。

  
## 4. 学習マシン
担当外ではあるが、インプットとアウトプットはきめなければならない。


京都データ　24ラベル
broデータ　47ラベル

### 京都データ

- 1, duration (connection)
- 2, service
- 3, source bytes
- 4, destination bytes
- 5, count
- 6, same_srv_rate
- 7, serror_rate
- 8, srv_serror_rate
- 9, dst_host_count
- 10, dst_host_srv_count
- 11, dst_host_same_src_port_rate
- 12, dst_host_serror_rate
- 13, dst-host-srv-serror-rate
- 14, flag
- 15, ids_detection
- 16, malware_detection
- 17, ashula_detection
- 18, label
- 19, source_ip_address
- 20, source_port_number
- 21, destination_ip_address
- 22, destination_port_number
- 23, start_time
- 24, duration (session)

### broデータ
- 1, num_conn
- 2, startTimet
- 3, orig_pt
- 4, resp_pt
- 5, orig_ht
- 6, resp_ht
- 7, duration
- 8, protocol
- 9, res_pt
- 10, flag
- 11, src_bytes
- 12, dst_bytes
- 13, land
- 14, wrong_fragment
- 15, urg
- 16, hot
- 17, num_failed_logins
- 18, logged_in
- 19, num_compromised
- 20, root_shell
- 21, su_attempted
- 22, num_root
- 23, num_file_creations
- 24, num_shells
- 25, num_access_files
- 26, num_outbound_cmds
- 27, is_hot_login
- 28, is_guest_login
- 29, count_sec
- 30, srv_count_sec
- 31, serror_rate_sec
- 32, srv_serror_rate_sec
- 33, rerror_rae_sec
- 34, srv_error_rate_sec
- 35, same_srv_rate_sec
- 36, diff_srv_rate_sec
- 38, srv_diff_host_rate_sec
- 39, Count_100
- 40, srv_count_100
- 41, same_srv_rate_100
- 42, diff_srv_rate_100
- 43, same_src_port_rate_100
- 44, srv_diff_host_rate_100
- 45, serror_rate_100
- 46, srv_serror_rate_100
- 47, rerror_rate_100
- 48, srv_rerror_rate_100

### 京都データ == broデータ
- 1, duration (connection)          == 7, duration
- 2, service                        == 8, protocol (データの型は一致しない)
- 3, source bytes                   == 11, src_bytes
- 4, destination bytes              == 12, dst_bytes
- 5, count                          == 39, Count_100 (40, srv_count_100は多分違う)
- 6, same_srv_rate                  == 41, same_srv_rate_100
- 7, serror_rate                    == 45, serror_rate_100
- 8, srv_serror_rate                == 46, srv_serror_rate_100
- 9, dst_host_count                 == 43, same_src_port_rate_100??????多分違う
- 10, dst_host_srv_count
- 11, dst_host_same_src_port_rate
- 12, dst_host_serror_rate
- 13, dst-host-srv-serror-rate
- 14, flag
- 15, ids_detection
- 16, malware_detection
- 17, ashula_detection
- 18, label
- 19, source_ip_address
- 20, source_port_number
- 21, destination_ip_address
- 22, destination_port_number
- 23, start_time
- 24, duration (session)

現在のラベリングは以下のものを使用。変更の可能性あり
FEATURES = [
    'duration',  
    'src_bytes',
    'dst_bytes',
    'count',
    'same_srv_rate',
    'serror_rate',
    'srv_serror_rate',
    'dst_host_count',
    'dst_host_srv_count',
    'dst_host_same_src_port_rate',
    'dst_host_serror_rate',
    'dst_host_srv_serror_rate',
    'service'
]

### zeek documentation (formerly bro)


#### documentation and training 

[documentation and training URL](https://www.zeek.org/documentation/)  
上記URLからinstallation->installing へと飛ぶ  

[Installing URL](https://docs.zeek.org/en/stable/install/install.html)  
上記URLに書いてあること読んで実行すればよい。とりあえず、自分がやったものを書く。  

[bro plugin](https://github.com/inigoperona/tcpdump2gureKDDCup99)



### 機械学習入門リンク

[cheet-sheet説明](https://engineers.weddingpark.co.jp/?p=872)
[scikit-learnを用いた機械学習入門 -データの取得からパラメータ最適化まで](https://qiita.com/sunafukin/items/34d0490cf5b5efb0346b)
[scikit-learn 入門](https://tutorials.chainer.org/ja/09_Introduction_to_Scikit-learn.html)