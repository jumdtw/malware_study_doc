# 卒論

## 1, 背景
IPAが発表した2019年における情報セキュリティ10大脅威で組織を狙った標的型攻撃による被害が昨年度ともに1位となっています
標的型攻撃とは特定の組織の秘密情報を標的とし様々な攻撃を仕掛けていくことです。その手段は多岐にわたり日々新しい攻撃手法が出現しています。
それらから情報資産を守る方法としてNIDSはとても重要になります。近年では機械学習型のNIDSが研究され、少数ながら既製品の販売もなされています。
既製品の具体的な学習データセットの公開はされてはいないものの多くの研究ではKDDCUP199といった公開されている通信データセットを使用して研究されています。
そこで本研究では、特定の組織での正常通信とその組織向けの悪性通信を取得し機械学習に利用する機械学習型のNIDSシステムを提案する。

## 2, 関連研究
文献[1]ではデータセットとしてKDDCUP199と文献[2]によって指摘されているKDDCUP199の問題点を解決したNSL－KDDデータセットを訓練データとして使用している。また、文献[3]ではKDDCUP199の最新の攻撃傾向の反映ができていない等の問題を解決したkyotodata 2016 Datesetを使用している。この他にも様々なデータセット(mwsデータセット)を用いた機械学習を利用した侵入検知システムがあるがいくつかの問題点が考えられます。
まず、これらデータセットは公開されているものであり攻撃者も中身を確認することができるためAdversarial attacksの危険性があります。
次に、正常通信は各組織によって大きく異なる場合が多いため特定のデータセットを使用すると正常通信の誤検知率が高くなる可能性があります。既製品の機械学習型NIDSでは誤検知の登録が可能な製品はありますが、新しい機材やソフトを導入するたびに誤検知登録をするのではメンテナンスの負担が重くなってしまいます。
また、その誤検知率を低くするための研究はいくつか見られますが運用に関する研究はあまりされていません。実際の運用を考えた時、侵入された際対処も大事になります。最新のNIDSでも検知率が100%になることはないため侵入された場合の対処も重要になってきます。

## 3, 提案

そこで本研究では特定の組織向けのデータセットを使用し、正常通信の逸脱と度合いから未知の通信かを判断することにより新しい攻撃手法への対応がしやすくさらにメンテナンスの負担が軽減されるような機械学習型のNIDSを検討する。提案手法のフローチャートを図1に示す。**(ここでフロー図を作成し、図で全体の流れを説明する)**まず、組織内の正常通信とハニーポットを設置しそこへ来る通信を既知の悪性通信として取得する。その際新しい機材やソフトを導入する場合はあらかじめそれらから出る通信データを取得しておき正常通信として加えます。それらすべての通信データから特徴量抽出する。そして、そのデータを使い機械学習を行うことによりNIDSの悪性通信の判別を可能とする。
3.1で正常通信の具体的な取得方法。3.2で既知の悪性通信の具体的な取得方法。3.3でそれら通信データから特徴量を抽出し学習する方法。3.4で新しい機材・ソフトの導入と内部通信に逸脱した通信を派遣した場合の対処方法をそれぞれ記述していきます。

### 3.1, 正常通信の取得 
監視組織内の正常通信を常時取得できる環境を作成する。これは組織内のPC間双方の通信を取得するものとして、各部署または組織正常通信が流れる大元のルーターにミラーリングポートを設定し、pcapデータフォーマットとして取得する。本実験では研究室内に流れる正常通信を研究室内のルーターにミラーリングポートを設定することで正常通信をpcapデータフォーマットとして取得する。

### 3.2, 既知の悪性通信の取得
監視組織内への悪性通信を常時取得できる環境を作成する。組織内にDMZを用意する。そこにハニーポットを設置し、ハニーポットに対して行われる通信を既知の悪性通信としpcapデータフォーマットとしてて取得する。本実験ではハニーポット専用のネットワークを作成する。その中のハニーポットへ行われる通信をすべてpcapデータフォーマットとして取得する。

### 3.3, 通信データから特徴量の抽出・学習方法
特徴量の抽出方法としてbroと呼ばれるソフトウェアのプラグインを使用する。これを使用することでpcapデータをcsv形式の特徴量ファイルに変換を行ってくれます。それを利用して特徴量データを取得、学習する。**(学習方法の部分は林さんと連絡をとり加筆していきます。)**

### 3,4, 新しい機材・ソフトの導入と内部通信に逸脱した通信を派遣した場合の対処
組織内に侵入したマルウェアや内部の犯行による悪性通信を検知した場合や新しいソフトが出した未知の通信を解析するために、組織内に解析用ネットワークを用意する。その未知の通信を検知した場合。そのPCまたはネットワークを隔離し解析用ネットワークへと移動させます。**(このあたりがまだ曖昧です。ネットワークブートするようなタイプでは状態を保存し解析用ネットワークへの以降は簡単ですが、たいていの会社はPCに対し物理的にOSをいれていると思うのでその辺への対処法を考えておきます。)**外部とのネットワークを遮断し内部への害を排除した状態でそのPCからでる通信をすべて取得し、人の手による判別を行います。未知の正常通信であった場合

## 4, 評価
<!--なるべく段落を分けるようにしたが逆に見づらいと思うので将来的には書き換えます。-->
### 4.1 評価概要
学習に必要な量の通常・悪性通信を取得し、これを用意手作成した提案NIDSの有効性を以下の３つで検証を行う。比較時の指標には、正解率、適合率、検知率、誤検知率の評価指標を用いる。今回使用する学習アルゴリズムの選定理由とその具体的なラベルの選択方法に関しての説明は共同研究者が検証した結果である。 使用するアルゴリズムはランダムフォレストで、特徴量は表1に示す。

<!--
#### 4.1.1 既存のデータセットでの判定
実験用のシステムに配置されているNIDSを既存のデータセットで学習されたNIDSにする。その際の実験用正常通信の評価指標を示す。
#### 4.1.2 未知の正常通信の判定 
未知の正常通信として用意した通信データを学習にかけきちんと正常通信として判定できるかの確認する。
#### 4.1.3 未知の悪性通信の判定
未知の正常通信と同様に用意した未知の悪性通信のデータを学習にかけきちんと悪性通信としてはんていできるのかの確認する。
#### 4.1.4 学習アルゴリズムと特徴量
今回使用する学習アルゴリズムの選定理由とその具体的なラベルの選択方法に関しての説明は共同研究者が検証した結果である。 使用するアルゴリズムはランダムフォレストで、特徴量は表1に示す。
-->

### 4.2 評価環境
提案するシステムの概念図、図1を基に作成した評価環境を図nに示す。
正常通信と悪性通信はそれぞれtcpdumpを使用してpcapファイルとしてキャプチャした。
#### 4.2.1 正常通信の取得方法
<!--今回の研究では研究室内の通信のキャプチャができていないのでその部分を書き替える必要がある。-->
図nの赤枠に囲われた部分を使用していきます。正常通信の取得では用意した研究室１から外部インターネット向けに行われる通信、研究室内PC間で行われる通信を取得した。
#### 4.2.2 既知の悪性通信の取得方法
図nの赤枠に囲われた部分を使用していきます。既知の悪性通信としてDMZにハニーポットのhoneytrapを設置しそこに対して行われる通信を悪性通信として取得した。使用したOSはubuntu18.04である。
#### 4.2.3 特徴量の抽出と学習
図nの赤枠に囲われた部分を使用していきます。通信データの取得後、解析用マシンで取得したファイルに対して学習可能な形式への変換を行う。本論文では、bro-IDS を使用した KDD Cup 99 Data Set 形式への変換を行った。bro-IDS 用に作成されたプラグイン、tcpdump2gureKDDCup99[4] を使用することで、tcpdump で取得された通信データを KDD Cup 99 Data Set の形式に変換することができる。変換方法の詳細については参考文献 [4] に記載されている。3.2.1 節で取得した pcap ファイルに対して、形式の変換を行う。変換後のファイルに対して、最終列に特徴量 “label” の追加を行う。“label” は “normal” と “mal”の 2 種である。特徴量追加後、通常・悪性通信と分割されているファイルを一つにまとめる。


### 4.3 評価方法
#### 4.3.1 評価指標
混合行列を表ｎに示す。
また、表ｎから算出される正解率（accuracy）、適合率（Precision）、検知率（true positive rate）、誤検知率(false positive rate)を算出した。書く指標の定義を以下に示す。
#### 4.3.2 提案NIDSと既存NIDSの比較
提案NIDSの評価指標の比較対象として既存NIDSを作成する。これは4.2で説明したシステムの学習データの部分を評価環境でキャプチャしたものではなく既存のKDD Cup Date setを使用して作成したものにである。これに対しても提案NIDSと同じテストデータを判別させることにより既存のNIDSが特定の組織の正常通信を判別するときの評価指標を示すことができる。
抽出した特徴量で学習を行い採取した通信データから判定を書けたところ検知率が99.29%という高い精度を得ることができた。また、データセットで学習を行い採取した通信データを判定に書けたところ検知率は52.62%にさがった。これは正常通信が採取する環境によって大きく異なることが原因であると考えられる。


#### 今後やりたいこと
aiの挙動から学習データの推測をすることがあるらしい

## 参考
[1] ニューラルネットワークを用いた侵入検知システム改良手法の検討
[2] a detailed analysis of the kdd cpu 00 data set
[3] 機械学習を用いた攻撃検知に関する学習手法の精度評価
